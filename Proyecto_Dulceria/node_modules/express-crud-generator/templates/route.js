var express = require('express');
var router = express.Router();


router.get("/:id/delete/confirm", function(req, res, next){
  <%= Model.class %>.find({ <%= Model.pk %>:req.params.id}, function(err, items){
    if ( err ){
      console.log("ERROR",err);
      res.send("");
      return;
    }

    if ( items == undefined ){
      res.send("404");
      return ;
    }

    items[0].remove(function(){ });

      res.redirect("<%= Model.url %>/");
  });

});

router.get("/:id/delete", function(req, res, next){
  <%= Model.class %>.find({ <%= Model.pk %>:req.params.id}, function(err, items){
    if ( err ){
      console.log("ERROR",err);
      res.send("");
      return;
    }

    if ( items == undefined ){
      res.send("404");
      return ;
    }

    res.render('index',{
        content:'<%= Model.name %>/delete',
        item: items[0]
      });

  });

});


router.get("/:id/show", function(req, res, next){
  <%= Model.class %>.find({ <%= Model.pk %>:req.params.id}, function(err, item){
    if ( err ){
      console.log("ERROR",err);
      res.send("");
      return;
    }

    if ( item == undefined ){
      res.send("404");
      return ;
    }

    res.send("Esta seguro de borrar");
  });

});



var list = function(req,res,next){

  if ( req.params.page == undefined ) req.params.page = 0;

  <%= Model.class %>.find({ })
      .limit(10)
      .offset(req.params.page*10)
      .run(function(err,items){
    if ( err ){
      console.log("ERROR", err);
      res.send("");
      return ;

    }

    <%= Model.class %>.count({ }, function(err, count){
      res.render('index',{content:'<%= Model.name %>/list', items: items, total: count});
    });


  });

};

router.get("/", list );

router.get("/p/:page", list );

router.get("/:id/edit", function(req, res, next){
  <%= Model.class %>.find({ <%= Model.pk %>:req.params.id}, function(err, items){
    if ( err ){
      console.log("ERROR",err);
      res.send("");
      return;
    }

    if ( items == undefined ){
      res.send("404");
      return ;
    }

    res.render('index',{
      content:'<%= Model.name %>/form',
      item:items[0]
    });
  });

});

router.get("/create", function(req, res, next){

    var item = new <%= Model.class %>;
    res.render('index',{
      content:'<%= Model.name %>/form',
      item: item
    });

});

router.post("/save", function(req, res, next){
  console.log(req.body);
  <%= Model.class %>.find({ <%= Model.pk %>:req.body.<%= Model.pk %>},
    function(err, items){
      if ( err ){
        console.log(err);
        return ;
      }

      if ( items.length > 0 ){
        var item = items[0];
      }else{
        var item = new <%= Model.class %>;
        item.<%= Model.pk %>  = undefined;

      }

      <% Object.keys(Model.schema).forEach(function(input){ %>
        <% if ( input == Model.pk ) return true; %>
      item.<%= input %> = req.body.<%= input %>;
      <% }); %>
      item.save(function(err, updated){
        console.log("UPDATED",err);
      });

      res.redirect("<%= Model.url %>/");

    });
  });



module.exports = router;
