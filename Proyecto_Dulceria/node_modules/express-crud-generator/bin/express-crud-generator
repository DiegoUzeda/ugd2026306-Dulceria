#!/usr/bin/env node

var path = process.cwd();
console.log("Express CRUD Generator ", path);

var program = require('commander');

program
	.version('0.0.1')
	.option('--model [model]', "Generate templates for model [model]")
	.option('--pk [pk]', "Primary Key")
	.option('--path [path]', "URL Path")
	.parse(process.argv);


var Model = {};
Model.class = program.model;
Model.name = program.model.toLowerCase();


if (program.model == undefined) {
	throw new Error("Model not defined")
}

Model.pk = program.pk;
if (program.pk == undefined) {
	Model.pk = "id";
}

Model.path = "";
if (program.path != undefined) {
	Model.path = program.path
}

var ejs = require("ejs");
var orm = require("orm");
var fs = require("fs");

var schemas = require(path + "/models/schema.js");

if (!fs.existsSync(path + "/routes"))
	fs.mkdirSync(path + "/routes");

if (!fs.existsSync(path + "/views"))
	fs.mkdirSync(path + "/views");

Model.routePath = path + "/routes/";
Model.viewPath = path + "/views/";

Model.url = "/" + Model.name;
if (Model.path != "") {
	if (!fs.existsSync(path + "/routes/" + Model.path))
		fs.mkdirSync(path + "/routes/" + Model.path);

	if (!fs.existsSync(path + "/views/" + Model.path))
		fs.mkdirSync(path + "/views/" + Model.path);

	Model.routePath = path + "/routes/" + Model.path + "/";
	Model.viewPath = path + "/views/" + Model.path + "/";
	Model.url = "/" + Model.path + "/" + Model.name;
}

if (schemas[Model.name] != undefined) {

	Model.schema = schemas[Model.name];


	if (!fs.existsSync(Model.viewPath + Model.name))
		fs.mkdirSync(Model.viewPath + Model.name);

	ejs.renderFile(__dirname + "/../templates/route.js", {
		Model: Model
	}, function (err, data) {
		if (err) console.log("ERROR ROUTE", err);

		data.replace("\n\r\n\r", "\n\r");
		fs.writeFile(Model.routePath + Model.name + ".js", data);
	});


	ejs.renderFile(__dirname + "/../templates/views/delete.ejs", {
		Model: Model
	}, function (err, data) {
		if (err) console.log("ERROR DELETE", err);

		fs.writeFile(Model.viewPath + Model.name + "/delete.ejs", data);
	});

	ejs.renderFile(__dirname + "/../templates/views/form.ejs", {
		Model: Model
	}, function (err, data) {
		if (err) console.log("ERROR FORM", err);

		fs.writeFile(Model.viewPath + Model.name + "/form.ejs", data);
	});

	ejs.renderFile(__dirname + "/../templates/views/list.ejs", {
		Model: Model
	}, function (err, data) {
		if (err) console.log("ERROR LIST", err);

		fs.writeFile(Model.viewPath + Model.name + "/list.ejs", data);
	});

} else {
	console.log(Model.name, "NOT FOUND");
}